(()=>{"use strict";let e={GROUP:{},PERSON:{}};const t={};function n(e,t,n,s,o,r){this.messageType=e,this.groupId=t,this.messageId=n,this.sender=s,this.sendTime=o,this.content=r}!function(){const t=localStorage.getItem("robotMessages");t&&(e=JSON.parse(t))}(),function s(){const o=document.querySelector("[role='application']");if(null==o)console.log("[WARN] Notfound messages container...");else{const s=document.querySelector("#main div[data-testid='conversation-info-header'] [data-testid='conversation-info-header-chat-title']"),r=s&&s.innerText,i=o.querySelectorAll("#main div[data-testid='conversation-panel-body'] div[role='row']");let l,a=!1;i.forEach((s=>{const o=function(e){const t=e.querySelector("div[data-id]");if(!t)return null;if(!t.querySelector("div.message-out div[data-testid='msg-container']"))return null;const s=t.getAttribute("data-id"),o=/(true)_(\d+)@g.us_([^_]+)_(.*)@c.us/.exec(s);let r=null,i=null,l=null,a=null;if(o)r="GROUP",i=o[2],l=o[3],a=o[4];else{const e=/(true)_(.+)@c.us_(.*)/.exec(s);if(!e)return null;r="PERSON",l=e[3],a=e[2],i=a}const c=t.querySelector("div.copyable-text"),d=c.getAttribute("data-pre-plain-text"),u=/\[[^d]+(\d+):(\d+), (\d+)年(\d+)月(\d+)日\]/.exec(d);let m=null;if(u){const e=u[1],t=u[2],n=`${u[3]}-${u[4]}-${u[5]} ${e}:${t}`;m=Date.parse(n)/1e3}else console.log("Parsed date error: ",d);let g=c.innerText;return"reset"===g||/^[-+*/]\d+(\.\d+)?$/.exec(g)?new n(r,i,l,a,m,g):null}(s);if(o){if(t[o.groupId]=r,l=e[o.messageType][o.groupId],l||(l={sum:0,lastSendTime:0,messages:{}},e[o.messageType][o.groupId]=l),l.lastSendTime>o.sendTime)return;if(l.messages[o.messageId])return;a=!0,function(e,t){"reset"===t.content?e.sum=0:t.content.startsWith("+")?e.sum+=parseFloat(t.content.substring(1)):t.content.startsWith("-")?e.sum-=parseFloat(t.content):t.content.startsWith("*")?e.sum=Math.floor(e.sum*parseFloat(t.content.substring(1))*100)/100:t.content.startsWith("/")&&(e.sum=Math.floor(e.sum/parseFloat(t.content.substring(1))*100)/100)}(l,o),l.messages[o.messageId]=o,l.lastSendTime<o.sendTime&&(l.lastSendTime=o.sendTime),function(e,t){let n=document.querySelector("#messages-floating");if(!n){const e=document.querySelector("#app > div");n=document.createElement("div"),n.setAttribute("id","messages-floating"),e.appendChild(n)}let s,o,r=n.querySelector(`#g-${t.groupId}`);null==r?(r=document.createElement("div"),r.setAttribute("id",`g-${t.groupId}`),n.appendChild(r),o=document.createElement("h3"),o.setAttribute("id",`g-${t.groupId}-title`),r.appendChild(o),s=document.createElement("ul"),r.appendChild(s)):(o=r.querySelector("h3"),s=r.querySelector("ul")),o.innerText=e;const i=document.createElement("li");i.innerText=t.content,s.appendChild(i)}(t[o.groupId],o),console.log("message=",o)}})),a&&(function(e){document.execCommand("insertText",!1,`【自动发送】 合计金额: ${e.sum}`),setTimeout((()=>{const e=document.querySelector("div[contenteditable='true'][data-testid='conversation-compose-box-input']");if(e&&e.innerText.startsWith("【自动发送】")){const e=document.querySelector("button[data-testid='compose-btn-send']");e?e.click():console.log("Notfound send message button")}}),3e3)}(l),localStorage.setItem("robotMessages",JSON.stringify(e)),console.log("messages=",e))}console.log("setTimeout fetchMessages"),setTimeout(s,1e3)}()})();